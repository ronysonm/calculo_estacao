---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/domain/models/Protocol.ts
  - src/domain/models/Round.ts
  - src/domain/models/Lot.ts
  - src/domain/models/index.ts
  - src/domain/constants/protocols.ts
  - src/domain/constants/index.ts
autonomous: true

must_haves:
  truths:
    - "Protocol type represents exactly 3 manejos as a readonly tuple of [number, number, number]"
    - "Pre-defined protocols (D0-D7-D9, D0-D8-D10, D0-D9-D11) exist as frozen immutable constants"
    - "Custom protocols can be created with any 3 day values and are marked as non-predefined"
    - "Pre-defined protocols cannot be edited or deleted (isPredefined flag enforced)"
    - "Round configuration supports 1-6 rounds with configurable interval per lot (default 22)"
    - "Lot model links a lot to its protocol, D0 date, and round interval"
  artifacts:
    - path: "src/domain/models/Protocol.ts"
      provides: "Protocol type definition and factory functions"
      exports: ["Protocol", "createProtocol", "updateProtocol"]
    - path: "src/domain/models/Round.ts"
      provides: "Round type definition and round label generation"
      exports: ["RoundConfig", "generateRoundLabels"]
    - path: "src/domain/models/Lot.ts"
      provides: "Lot type definition and factory functions"
      exports: ["Lot", "createLot"]
    - path: "src/domain/constants/protocols.ts"
      provides: "Pre-defined protocol constants"
      exports: ["PREDEFINED_PROTOCOLS", "getAllProtocols"]
    - path: "src/domain/models/index.ts"
      provides: "Barrel export for all domain models"
      exports: ["Protocol", "Lot", "RoundConfig"]
  key_links:
    - from: "src/domain/constants/protocols.ts"
      to: "src/domain/models/Protocol.ts"
      via: "imports Protocol type and createProtocol factory"
      pattern: "import.*Protocol.*from"
    - from: "src/domain/models/Lot.ts"
      to: "src/domain/models/Protocol.ts"
      via: "Lot references Protocol by id"
      pattern: "protocolId.*string"
---

<objective>
Create the immutable domain model layer: Protocol, Round, and Lot types with factory functions, plus pre-defined protocol constants. This is pure TypeScript with zero React dependency — the foundation all calculation and UI code builds on.

Purpose: Every feature in the app (date calculation, UI, conflict detection) depends on well-typed, immutable domain objects. Getting these right prevents cascading bugs.
Output: Complete domain model with types, factories, constants, and barrel exports.
</objective>

<execution_context>
@/home/suporte/.claude/get-shit-done/workflows/execute-plan.md
@/home/suporte/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain model types and factory functions</name>
  <files>
    src/domain/models/Protocol.ts
    src/domain/models/Round.ts
    src/domain/models/Lot.ts
    src/domain/models/index.ts
  </files>
  <action>
    Create pure TypeScript domain types with NO React imports. All properties readonly. All creation via factory functions that return frozen objects.

    **Protocol.ts:**
    - Interface `Protocol` with readonly fields:
      - `id: string` (UUID)
      - `name: string` (e.g., "D0-D7-D9" — named by day sequence per user decision)
      - `days: readonly [number, number, number]` (exactly 3 manejos, first is always 0 for D0)
      - `isPredefined: boolean`
    - Factory function `createProtocol(days: [number, number, number], isPredefined?: boolean): Protocol`
      - Auto-generates name from days: `D${days[0]}-D${days[1]}-D${days[2]}`
      - Auto-generates UUID via crypto.randomUUID()
      - Freezes the days array with Object.freeze()
    - Function `updateProtocol(protocol: Protocol, updates: { days?: [number, number, number] }): Protocol`
      - Returns new Protocol instance (immutable update)
      - Recalculates name if days change
      - Throws if protocol.isPredefined is true (pre-defined protocols cannot be edited per user decision)
    - Function `canDeleteProtocol(protocol: Protocol): boolean` — returns !protocol.isPredefined

    **Round.ts:**
    - Interface `RoundConfig` with readonly fields:
      - `count: number` (1-6, default 4 — global, all lots share this)
      - `defaultInterval: number` (default 22 days)
    - Constant `DEFAULT_ROUND_CONFIG: RoundConfig` with count=4, defaultInterval=22
    - Function `generateRoundLabels(count: number): string[]` — returns ["A1", "A2", ...] up to count
    - Note: Round count is global per user decision. Interval is per lot (stored on Lot, not here).

    **Lot.ts:**
    - Interface `Lot` with readonly fields:
      - `id: string` (UUID)
      - `name: string` (e.g., "Primiparas")
      - `protocolId: string` (references Protocol.id)
      - `d0: Date` (start date for this lot)
      - `roundInterval: number` (default 22, configurable per lot per user decision)
    - Factory function `createLot(name: string, protocolId: string, d0: Date, roundInterval?: number): Lot`
      - Default roundInterval = 22
    - Function `updateLot(lot: Lot, updates: Partial<Pick<Lot, 'name' | 'protocolId' | 'd0' | 'roundInterval'>>): Lot`
      - Returns new Lot instance

    **index.ts:**
    - Barrel export all types and functions from Protocol, Round, Lot modules.

    Per user decision: "sem restricao de validacao" — do NOT add validation that restricts user values for protocol days or round intervals. The factory functions accept any numbers.
  </action>
  <verify>
    Run: npm run type-check — zero TypeScript errors.
    Verify that Protocol.days is typed as readonly tuple (not number[]).
    Verify that updateProtocol throws for pre-defined protocols.
  </verify>
  <done>
    Protocol, RoundConfig, and Lot types exist with readonly properties. Factory functions create frozen instances. updateProtocol refuses to modify pre-defined protocols. All types export from barrel index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pre-defined protocol constants and getAllProtocols helper</name>
  <files>
    src/domain/constants/protocols.ts
    src/domain/constants/index.ts
  </files>
  <action>
    **protocols.ts:**
    - Import Protocol type and createProtocol from domain models
    - Create 3 pre-defined protocols using createProtocol with isPredefined=true:
      1. D0-D7-D9: days [0, 7, 9]
      2. D0-D8-D10: days [0, 8, 10]
      3. D0-D9-D11: days [0, 9, 11]
    - Use stable IDs for pre-defined protocols (not random UUIDs):
      - "predefined-d0-d7-d9"
      - "predefined-d0-d8-d10"
      - "predefined-d0-d9-d11"
      This ensures pre-defined IDs are consistent across sessions (important for localStorage).
    - Override the random UUID from createProtocol by constructing the objects directly or by having createProtocol accept an optional id parameter.
    - Export as `PREDEFINED_PROTOCOLS: readonly Protocol[]` frozen with Object.freeze()
    - Function `getAllProtocols(customProtocols: Protocol[]): Protocol[]`
      - Returns [...PREDEFINED_PROTOCOLS, ...customProtocols]
      - Pre-defined always come first
    - Function `getProtocolById(id: string, customProtocols: Protocol[]): Protocol | undefined`
      - Searches predefined first, then custom
    - Export `DEFAULT_LOT_NAMES: readonly string[]` with the 5 standard lot names:
      ["Primiparas", "Secundiparas", "Multiparas/Solteiras", "Novilhas Tradicional", "Novilhas Precoce"]

    **index.ts:**
    - Barrel export from protocols.ts

    Per user decision: Pre-defined protocols are fixed — cannot be edited or deleted. The isPredefined=true flag on these protocols enforces this through the updateProtocol guard in Protocol.ts.
  </action>
  <verify>
    Run: npm run type-check — zero errors.
    Verify PREDEFINED_PROTOCOLS has exactly 3 entries with correct days values.
    Verify getAllProtocols returns predefined + custom concatenated.
    Verify getProtocolById finds predefined protocols by stable ID.
  </verify>
  <done>
    3 pre-defined protocols exist as frozen constants with stable IDs. getAllProtocols merges predefined + custom. getProtocolById enables lookup. DEFAULT_LOT_NAMES lists the 5 standard lots.
  </done>
</task>

</tasks>

<verification>
1. `npm run type-check` passes with domain models in place
2. All domain types use readonly properties
3. Pre-defined protocols have stable IDs (not random UUIDs)
4. updateProtocol throws on pre-defined protocol mutation
5. Factory functions return new instances (immutability)
6. Barrel exports work: `import { Protocol, Lot, PREDEFINED_PROTOCOLS } from '@/domain/models'`
</verification>

<success_criteria>
- Protocol type enforces exactly 3 manejos via readonly tuple
- 3 pre-defined protocols exist with correct day sequences
- Pre-defined protocols are immutable (edit/delete blocked)
- Custom protocols can be created with any day values (no validation restrictions)
- Lot model links lot to protocol with per-lot interval configuration
- Round config defaults to 4 rounds, 22-day interval
- All types importable via barrel exports
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
